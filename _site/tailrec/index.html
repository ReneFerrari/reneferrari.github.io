<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> <title>WIP tailrec üêà &#8211; Rene Ferrari</title> <meta name="description" content="tailrec üêà"> <meta name="keywords" content=""> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="avatar.jpg"> <meta name="twitter:title" content="WIP tailrec üêà"> <meta name="twitter:description" content="tailrec üêà"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="WIP tailrec üêà"> <meta property="og:description" content="tailrec üêà"> <meta property="og:url" content="http://localhost:4000/tailrec/"> <meta property="og:site_name" content="Rene Ferrari"> <meta property="og:image" content="http://localhost:4000/images/avatar.jpg"> <link rel="canonical" href="http://localhost:4000/tailrec/"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Feed --> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Rene Ferrari" /> <!-- CSS --> <link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/main.css"> <!-- Left Block Image for Posts --> <style type="text/css"> #posts.inner-post-page .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(http://localhost:4000/images/unsplash-gallery-image-3.jpg) no-repeat;background-size: cover;} </style> <!-- Left Block Images for Home and Pages --> <style type="text/css"> #posts .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(http://localhost:4000/images/unsplash-image-10.jpg) no-repeat;background-size: cover, cover;} .block-left {background: linear-gradient(rgba(28, 28, 28, 0.75), rgba(48, 48, 48, 0.75)), url(http://localhost:4000/images/home.jpg) no-repeat;background-size: cover;} </style> </head> <body id="posts" class="inner-post-page" style="background: #ececec52;"> <div style="overflow-y:auto; height: 100%;"> <a href="http://localhost:4000"> <h3 style="margin-left: 56px;">Home</h3> </a> <div class="inner-post content-post" style="padding-top: 0px;"> <h1 style="text-align: center;">WIP tailrec üêà </h1> <div class="date-highlight">12 Dec 2019</div> <h2 id="introduction">Introduction</h2> <p><code class="highlighter-rouge">tailrec</code> is a keyword which enables optimization of tail recursive functions. These are functions that have a recursive call as their last statement. Instead of creating a new stack entry for each recursive call, functions marked as tailrec ‚Äúreuse‚Äù the existing one.</p> <p>A simple example:</p> <figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="k">tailrec</span> <span class="k">fun</span> <span class="nf">factorial</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="nv">accumulator</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="m">1</span><span class="p">):</span> <span class="nc">Int</span> <span class="p">=</span> <span class="k">when</span> <span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
    <span class="m">1</span> <span class="p">-&gt;</span> <span class="n">accumulator</span>
    <span class="k">else</span> <span class="p">-&gt;</span> <span class="n">factorial</span><span class="p">(</span><span class="n">start</span> <span class="p">-</span> <span class="m">1</span><span class="p">,</span> <span class="n">accumulator</span> <span class="p">*</span> <span class="n">start</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure> <h2 id="comparison-to-a-regular-recursive-function">Comparison to a regular recursive function</h2> <p>The previously shown function could be written without tailrec - like this:</p> <figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="k">fun</span> <span class="nf">factorialRegular</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="nv">accumulator</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="m">1</span><span class="p">):</span> <span class="nc">Int</span> <span class="p">=</span> <span class="k">when</span> <span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
    <span class="m">1</span> <span class="p">-&gt;</span> <span class="n">accumulator</span>
    <span class="k">else</span> <span class="p">-&gt;</span> <span class="n">factorialRegular</span><span class="p">(</span><span class="n">start</span> <span class="p">-</span> <span class="m">1</span><span class="p">,</span> <span class="n">accumulator</span> <span class="p">*</span> <span class="n">start</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure> <p>To understand how the tailrec version is ‚Äúreusing‚Äù the stack entry we must take a look at the bytecode decompiled to Java:</p> <figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="c1">// tailrec version</span>
<span class="k">public</span> <span class="n">static</span> <span class="k">final</span> <span class="n">int</span> <span class="n">factorial</span><span class="p">(</span><span class="n">int</span> <span class="n">start</span><span class="p">,</span> <span class="n">int</span> <span class="n">accumulator</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">switch</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">case</span> <span class="m">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">accumulator</span><span class="p">;</span>
        <span class="nv">default</span><span class="p">:</span>
        <span class="nc">int</span> <span class="n">var10000</span> <span class="p">=</span> <span class="n">start</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span>
        <span class="n">accumulator</span> <span class="p">*=</span> <span class="n">start</span><span class="p">;</span>
        <span class="n">start</span> <span class="p">=</span> <span class="n">var10000</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="c1">// regular version</span>
<span class="k">public</span> <span class="n">static</span> <span class="k">final</span> <span class="n">int</span> <span class="n">factorialRegular</span><span class="p">(</span><span class="n">int</span> <span class="n">start</span><span class="p">,</span> <span class="n">int</span> <span class="n">accumulator</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">int</span> <span class="n">var10000</span><span class="p">;</span>
    <span class="n">switch</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">case</span> <span class="m">1</span><span class="p">:</span>
        <span class="n">var10000</span> <span class="p">=</span> <span class="n">accumulator</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="nv">default</span><span class="p">:</span>
        <span class="nc">var10000</span> <span class="p">=</span> <span class="n">factorialRegular</span><span class="p">(</span><span class="n">start</span> <span class="p">-</span> <span class="m">1</span><span class="p">,</span> <span class="n">accumulator</span> <span class="p">*</span> <span class="n">start</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">var10000</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure> <p>You will immediately notice that a function marked as tailrec is actually not recursive (on a decompiled Java code level). Instead the whole magic behind it is just an endless while loop.</p> <h2 id="more-in-depth">More in depth</h2> <p>What I have already explained should be sufficient knowledge for day to day programming. However there are still some unanswered questions:</p> <ul> <li>Why doesn‚Äôt the compiler automatically optimize tailrec functions?</li> <li>Why has the return type ((even for such a simple example like factorial calculation) be specified explicitly?</li> <li>Why doesn‚Äôt Java support tailrec?</li> <li>Why is a while(true) loop used instead of clearing the callstack?</li> <li>What is mutual tail recursion?</li> <li>Why doesn‚Äôt Kotlin support mutual tail recursion?</li> </ul> <h3 id="why-doesnt-the-compiler-automatically-optimize-tailrec">Why doesn‚Äôt the compiler automatically optimize tailrec?</h3> <p>I am just going to quote Roman Elizarov from the Jetbrains team:</p> <blockquote> <p>Implicit tailrec optimization is very fragile and error-prone. People make mistakes and tailrec modifier is here to explicitly declare programmer‚Äôs intent to define a tailrec function. You (as a programmer) declare your intent and compiler verifies it. It also serves as a helpful piece of documentation for future readers and maintainers of your code. If they accidentally break it, they‚Äôll get caught by compiler.</p> </blockquote> <h3 id="why-has-the-return-type-be-specified-explicitly">Why has the return type be specified explicitly?</h3> <p>One word: Speed.</p> <p>With a more complicated type inference the compiler could figure out the return type, but unfortunately this would cause the compilation process to be a lot slower.</p> <h3 id="why-doesnt-java-support-tailrec">Why doesn‚Äôt Java support tailrec?</h3> </div> <!-- JS --> <script src="http://localhost:4000/assets/js/main.min.js"></script> <div class="overlay"> <ul class="projects-menu"> <li style="background:url(http://taylantatli.me/Halve/images/halve-home-image.png) center center no-repeat;"> <a href="http://taylantatli.me/Halve" class="inactive" target="_blank" rel="nofollow external"> <span> Halve Jekyll Theme <br><em>in progress</em> </span> </a> </li> <li style="background:url(https://cloud.githubusercontent.com/assets/754514/14509720/61c61058-01d6-11e6-93ab-0918515ecd56.png) center center no-repeat;"> <a href="http://taylantatli.me/Moon" target="_blank" rel="nofollow external"> <span> Moon Jekyll Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Ramme/master/assets/img/screenshot-post.png) center center no-repeat;"> <a href="http://taylantatli.me/Ramme" target="_blank" rel="nofollow external"> <span> Ramme Jekyll Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Daisy-Pelican-Theme/master/Preview-1.png) center center no-repeat;"> <a href="http://taylantatli.me/Daisy-Pelican-Theme/" target="_blank" rel="nofollow external"> <span> Daisy Pelican Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Block-Icon-Theme/master/Preview.png) center center no-repeat;"> <a href="https://github.com/TaylanTatli/Block-Icon-Theme" class="inactive" target="_blank" rel="nofollow external"> <span> Block Icon Theme <br><em>in progress</em> </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/StartPage/master/preview.png) center center no-repeat;"> <a href="http://taylantatli.me/StartPage/" class="inactive" target="_blank" rel="nofollow external"> <span> Start Page <br><em>in progress</em> </span> </a> </li> </ul> </div> </div> </body> </html>
